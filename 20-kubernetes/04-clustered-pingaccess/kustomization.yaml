kind: Kustomization
apiVersion: kustomize.config.k8s.io/v1beta1

resources:
- ../01-standalone/pingaccess
- pingaccess-engine.yaml

generatorOptions:
  disableNameSuffixHash: true

configMapGenerator:
  - name: pingaccess-engine-environment-variables
    files: 
      - engine_env_vars
      
images:
  - name: pingidentity/pingaccess
    newTag: 5.3.1-alpine-edge

patches:
- target:
    kind: Service
    name: ^pingaccess$
  patch: |-
    - op: replace
      path: /spec/ports
      value: [{"port":9000,"name":"pa-admin"},{"port":9090,"name":"pa-cluster"}]
- target:
    kind: Deployment
    name: ^pingaccess$
  patch: |-
    - op: replace
      path: /spec/template/spec/containers/0/ports
      value: [{"containerPort":9000},{"containerPort":9090}]

patchesStrategicMerge:
- |-
  apiVersion: v1
  data:
    env_vars: |-
      SERVER_PROFILE_URL="https://www.github.com/pingidentity/pingidentity-server-profiles.git"
      SERVER_PROFILE_PATH="pa-clustering/pingaccess"
      OPERATIONAL_MODE="CLUSTERED_CONSOLE"
      PA_CONSOLE_HOST="pingaccess"
  kind: ConfigMap
  metadata:
    name: pingaccess-environment-variables